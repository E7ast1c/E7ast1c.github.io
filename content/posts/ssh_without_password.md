+++
draft = true
date = "{{ .Date }}"
title = "Настройка входа на VPS сервер по SSH без пароля, с RSA сертификатом"
description = "post-title"
slug = ""
authors = []
tags = ["ssh"]
categories = []
externalLink = ""
series = []
+++

В данном примере мы вместе настроим удаленный сервер с ОС **Ubuntu 20.04.3 LTS** для входа на сервер с помощью сертификата, который будет располагаться у нас на компьютере c Mac OS 11.6.

Как это работает?

Как сгенерировать публичный и приватные ключи на своем компьютере?

Как скопировать сгенерированные ключи на VPS сервер?

Выключаем вход по паролю, проверяем настройку

Дополнительно

Для входа на сервер по ключу мы создаем у себя пару ключей (открытую и закрытую), открытый ключ, с расширением `.pub` мы сохраним на сервере, а закрытый будет лежать у нас на компьютере.

Сгенерируем ключи (по умолчанию создает ключи длинной 2048 бит, флаг -b позволит создать ключи длинной 4096 бит, что дает дополнительный плюс к безопасности)

```
ssh-keygen
```

После ввода команды нам зададут несколько вопросов, сначала нас спросят по какому пути сохранить наш ключ, если пропустить данный шаг, то ключ будет сохранен по пути `/Users/MyUser/.ssh/id_rsa`
Также мы можем переопределить путь или задать другое имя ключа, как настроить подключение по разным ключам поговорим в секции  "Дополнительно", а сейчас введем `/Users/MyUser/.ssh/test`

```
Enter file in which to save the key (/Users/MyUser/.ssh/id_rsa): /Users/MyUser/.ssh/test
```

Мы можем назначить пароль для ключа, или оставить пустым

```
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
```

Наш ключ сгенерирован, мы получим информационное сообщение о том куда закрытый `/Users/MyUser/.ssh/test.` и открытый ключ был сохранен `/Users/MyUser/.ssh/test.pub.`, а также немного дополнительной информации в виде отпечатка и рандомизированного изображения ключа

```
Your identification has been saved in /Users/MyUser/.ssh/test.
Your public key has been saved in /Users/MyUser/.ssh/test.pub.
The key fingerprint is:
SHA256:OPmJ1mUOnARTrihakBxYWg1LPrEVL+1JAmRyS0BpBAs MyUser@my-computer
The key's randomart image is:
+---[RSA 3072]----+
|EB*+* +o.        |
|+===+o.*         |
|+o.+.=o *        |
| .  =. @ o       |
|  o ..= S o      |
| o .   = *       |
|.     o + .      |
|     .           |
|                 |
+----[SHA256]-----+
```

# **Копирование открытого ключа с помощью программы ssh-copy-id**

Программа `ssh-copy-id` присутствует во многих дистрибутивах linux, поэтому наиболее вероятно что этот вариант вам подойдёт по умолчанию.

Для копирования открытой части ключа, достаточно произвести копирования ключа следующей командой:

```
ssh-copy-id username@remote_host
```

Если вы ни разу не заходили на сервер, то вероятнее всего вы получите следующее предупреждение:

```
The authenticity of host '200.0.113.1 (200.0.113.1)' can't be established.
ECDSA key fingerprint is fd:fd:d4:f9:77:fe:73:84:e1:55:00:ad:d6:6d:22:fe.
Are you sure you want to continue connecting (yes/no)? yes
```

Это означает, что ваша локальная машина не знает данный хост. Достаточно ввести “yes” и нажать “Enter”.

После чего программа будет искать в директории локального пользователя ключ id_rsa.pub (открытый), который мы создали ранее. Если утилита найдёт этот файл, то программа копирования запросит пароль для входа на удалённый хост.

```
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
username@200.0.113.1's password:
```

Введите пароль, обратите внимание, что ввод пароля не отображается по соображениям безопасности. Далее нажмите ввод. После этого программа скопирует содержимое ключа из `~/.ssh/id_rsa.pub` в файл `authorized_keys` в поддиректории `~/.ssh` домашней директории вашего пользователя на удалённом хосте. В результате вы увидите следующее сообщение:

```
Вывод
Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'username@200.0.113.1'"
and check to make sure that only the key(s) you wanted were added.
```

Таким образом ключ загружен на удалённый сервер.

# **Копирование ключа вручную**

Иногда бывают случаи. когда отсутствует утилита ssh-copy-id (особенно на старых операционных системах). Поэтому можно скопировать ключ вручную. Один из вариантов – это передать ключ по ssh. Для этого мы будем считывать ключ, с помощью команды cat, затем передавать его через pipe команде ssh, которая создаст ключ и разместит его в файле.

```
cat ~/.ssh/id_rsa.pub | ssh username@remote_host "mkdir -p ~/.ssh && touch ~/.ssh/authorized_keys && chmod -R go= ~/.ssh && cat >> ~/.ssh/authorized_keys"

```

Если это подключение будет в первый раз, нужно будет точно так же согласиться с данным соединением и затем ввести пароль.

Аналогично, можно все эти действия проделать вручную. Например, если вы не имеете доступ по ssh к удалённой машине. Для начала надо вывести содержимое открытого ключа на вашей локальной машине.

```
cat ~/.ssh/id_rsa.pub
```

Вы получите содержимое файла ключа, которое будет выглядеть примерно так:

```
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABABBCAQCqql6MzstZYh1TmWWv11q5O3pISj2ZFl9HgH1JLknLLx44+tXfJ7mIrKNxOOwxIxvcBF8PXSYvobFYEZjGIVCEAjrUzLiIxbyCoxVyle7Q+bqgZ8SeeM8wzytsY+dVGcBxF6N4JS+zVk5eMcV385tY3Y6ON3EG112n6d+SMXY0OEBIcO6x+PnUSGHrSgpBgX7Ks1r7xqFa7heJiit2wWwkARptX7udSq05paBhcpB0pHtA1Rfz3K2B+ZVIpSDfki9UVKzT8JUmlL6NNzSgxUfQHGwnW7kj4jp4AT0VZk3ADw497M2G/12N0PPB5CnhHf7ovof5nL1ikrygTKRFmNZISvAcywB9GVqNAVE+ZHDSCuURNsAInVzgYo9xgJDW8wUw2o8U77+xiFxgI5QSZX3Iq7YLMgeksaO4rBJEa54k8m5wEiEE1nUhLuJ0X/vh2xPff6SQ1BL/zkOhvJCACK6Vb15mDOeCSq54Cr7kvS46itMosi/uS66+PujOO+xt/2FWYepz6ZlN70bRly57Q06J+ZJoc9FfBCbCyYH7U/ASsmY095ywPsBo1XQ9PqhnN1/YOorJ068foQDNVpm146mUpILVxmq41Cj55YKHEazXGsdODbXWhcrRf4G2fJLRcGUr9q8/lERo9oxRm5JPA6TCmj6kmiFqv+Ow9gI0x8GvaQ== demo@test

```

После чего на удалённой машине необходимо создать папку ~/.ssh. Команда ниже создаст директорию, если её не существовало.

```
mkdir -p ~/.ssh
```

Теперь можем дописать публичный ключ нашей локальной машины на удалённую в конец файла *`authorized_keys`* :

```
echo строка_публичного_ключа >> ~/.ssh/authorized_keys
```

Обратите внимание, что надо заменить “строка_публичного_ключа” на вывод команды `cat ~/.ssh/id_rsa.pub`.

После чего, необходимо убедиться, что директория ~/.ssh и файл `authorized_keys`  имеют соответствующие права доступа:

```
chmod -R go= ~/.ssh
```

Если вы используете акаунт root, для настройки ключей. То не забудьте поменять права пользователя, чтобы директория и файлы ключей принадлежали пользователю, а не root. Делается следующей командой:

```
chown -R user:user ~/.ssh
```

Где, user следует заменить на имя вашего пользователя.

# **Подключение к удалённому серверу и отключение логина по паролю**

После всех процедур вы можете попробовать подключиться к удалённому серверу.

```
ssh username@remote_host_address
```

Если при создании пары ключей вы не задали ключевую фразу (passphrase), вы будете залогинены автоматически. Если вы задали ключевую фразу, вам будет предложено её ввести. Это означает, что вы всё сделали верно. Теперь можно отключить логин по паролю. Для этого отредактируем файл sshd_config:

```
sudo nano /etc/ssh/sshd_config

```

Вам нужно найти поле: PasswordAuthentication . Она может быть даже закоментирована. Её необходимо раскоментировать и поставить значение no.

```
...
PasswordAuthentication no
...
```

Сохраните и закройте файл нажав `CTRL` + `X`, затем `Y` для подтверждения сохранения файла, а далее `ENTER` для выхода из текстового редактора nano. Для того, чтобы изменения вступили в силу, нам необходимо перезапустить демон sshd:

```
sudo systemctl restart ssh
```

Всё, теперь можете открыть новое окно терминала, и проверить соединение по ssh по вашему логину. Всё должно работать без пароля.

## Дополнительно

Если вы назначили уникальный путь или имя ключа, а также если у вас несколько ключей с которыми вы авторизуетесь на серверах вам необходимо явно задать путь до файла с ключами

Флаг `-i` задает путь до файла с ключами

```
ssh -p 22 -i "~/.ssh/id_rsa.pub" username@remote_host_address
```